#!/usr/bin/env groovy

// Configure the build properties
properties([
    buildDiscarder(logRotator(numToKeepStr: '600', daysToKeepStr: '7')),
    disableConcurrentBuilds(),
])

pipeline {
  environment { 

  // FIXME: need a way to inject the github PR-branch to  control-node main.tf so it can use it
  //  atm is using only the manager31 or head. fix here or in sumaform-testsrunner

  // +++++++
  // ADAPT: these variables need adaptation for branch, here is specific for HEAD branch
  // +++++++
  // * jenkins or pipeline or deploy specific
     ctl_node = 'prs-31-ctl.cloud.suse.de'
     maintf = '31-prs.tf'
     obs_from_github = 'Devel:Galaxy:Manager:3.1:Pr-Automation'
     branch = "Manager-3.1"
  // * gitarro specific
     context = "cucumber_31_pr_tests_experimental_00"

  // -----
  // DONT MODIFY this variables ( they will be stay fixed)
  // -----
     scripts = "${env.WORKSPACE}/jenkins_pipelines/cucumber_per_prs/common_scripts"
     test = "${scripts}/git2obs.sh ${obs_from_github}"
     repository = "SUSE/spacewalk"
     description = "cucumber tests for ${branch} branch"
     git_fs = "${env.WORKSPACE}"
     check = "gitarro.ruby2.1  -r ${repository}" + 
                " -c \"${context}\" -d \"${description}\" " +
                " -t ${test} " +
                " -g ${git_fs} " +
                " -b \"${branch}\" " +
                "--check --changed_since 3600" 

     runtest = "gitarro.ruby2.1  -r ${repository}" + 
                " -c \"${context}\" -d \"${description}\" " +
                " -g ${git_fs} " +
                " -u \"${env.BUILD_URL}\" " +
                " -b \"${branch}\" " +
                " -t ${test} " 

     sumaform_runner_url = 'https://gitlab.suse.de/galaxy/sumaform-test-runner'
     sumaform_url = 'https://github.com/moio/sumaform.git'
     ssh_flags = '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
     exec_tests = 'run-testsuite'
    }
    agent {label 'sumaform-cucumber' }
    stages {


   // ISSUE 01: obs can stay building forever.
    stage('wait that obs repo pkg are published and ready') {
        steps {
                  sh "ruby ${scripts}/ck_obs_pr_status.rb ${obs_from_github}"
                  sh "${scripts}/status_obs_rpm.sh ${obs_from_github}"     
               }
     }

    stage('Check Pull Request') {
        steps { 
               sh "${check} | grep \"TESTREQUIRED=true\" "
              }
     }

    stage('Build rpm from github PR') {
          steps { 
                  sh "${runtest}" 
                }

      }
   // ISSUE 01: obs can stay building forever and never publish pkgs
    stage('wait for new builded from github branch rpms publication and status') {
          steps {
                  sh "ruby ${scripts}/ck_obs_pr_status.rb ${obs_from_github}"
                  sh "${scripts}/status_obs_rpm.sh ${obs_from_github}"     
                }
     }
 
    stage('Deploy cucumber vms with rpms from github on ECP cloud') {
            steps {
                dir('prod') {
                    git url: sumaform_runner_url
                }
                dir('prod/cucumber-on-prs/sumaform') {
                    git url: sumaform_url
                }
                sh "mv prod/cucumber-on-prs/${maintf} prod/cucumber-on-prs/sumaform"

                dir('prod/cucumber-on-prs/sumaform') {
                    sh 'terraform init'
                    sh 'terraform apply'
                }
            }
     }
     stage('run cucumber testsuite') {
            steps {
                sh "ssh ${ssh_flags} -tt root@${ctl_node} \"${exec_tests}\""
                sh "scp ${ssh_flags} root@${ctl_node}:root/spacewalk/testsuite/output.html ${env.WORKSPACE}"
                sh "scp ${ssh_flags} -rp root@$ctl_node:root/spacewalk/testsuite/results_junit ${env.WORKSPACE}"
            }
        }
   }
   post {
        always {
            dir('prod/cucumber-on-prs/sumaform') {
                sh 'terraform destroy -force'

            }
            junit "${env.WORKSPACE}/results_junit/*.xml"
            archiveArtifacts artifacts: "${env.WORKSPACE}/output.html"
            // Always restore the pr-automation obs branch to head status. (keep pkg up2date)
            // we check at the begin of the pipeline on the status of the obs branch
            echo '-- restoring obs pkg to test pr-automation obs repo -- '
            sh "${scripts}/restore_obs_upstream.sh ${obs_from_github} ${branch}"     
            dir("${env.WORKSPACE}") {
                deleteDir()
            }
        }
    }
}
