#!/usr/bin/env groovy

properties([
    buildDiscarder(logRotator(daysToKeep: 365, numToKeep: 5000, artifactDaysToKeep: 365, artifactNumToKeep: 5000)),
    disableConcurrentBuilds(),
])

pipeline {
    environment {
        sumaform_runner_url = 'https://gitlab.suse.de/galaxy/sumaform-test-runner'
        sumaform_url = 'https://github.com/moio/sumaform.git'
        ssh_flags = '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
        server_node = 'pts-server.cloud.suse.de'
    }
    agent {
        label 'performance-tests'
    }
    triggers {
        cron('H H/2 * * *')
    }
    stages {
        stage('Deploy VMs on ECP') {
            steps {
                dir('prod/performance/runner') {
                    git url: sumaform_runner_url
                }
                dir('prod/performance/sumaform') {
                    git url: sumaform_url
                }
                sh "mv prod/performance/runner/performance/* prod/performance/sumaform"

                dir('prod/performance/sumaform') {
                  ansiColor('xterm') {
                    sh 'terraform init'
                    sh 'terraform apply'
                  }
                }
            }
        }

        stage('Patch all evil minions') {
          steps {
            sh "ssh $ssh_flags -tt root@$server_node run-pts --patching-only"
          }
        }

        stage('Locust stress tests') {
            steps {
                sh "ssh $ssh_flags -tt root@$server_node run-pts --locust-only"
            }
        }
    }
    post {
       always {
           dir('prod/performance/sumaform') {
             ansiColor('xterm') {
               sh 'terraform destroy -force'
             }
           }
           dir("${env.WORKSPACE}") {
              deleteDir()
           }
       }
    }
}
