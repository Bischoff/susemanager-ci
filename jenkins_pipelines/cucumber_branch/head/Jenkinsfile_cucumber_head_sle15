#!/usr/bin/env groovy

properties([
    buildDiscarder(logRotator(numToKeepStr: '600', daysToKeepStr: '7')),
    disableConcurrentBuilds(),
])

pipeline {
  environment { 
     ctl_node = 'cloud-ci-head-ctl.mgr.suse.de'
     maintf = 'head/os-matrix/main-sle15.tf'
     ssh_flags = '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
     sumaform_runner_url = 'https://gitlab.suse.de/galaxy/sumaform-test-runner'
     sumaform_url = 'https://github.com/moio/sumaform.git'
    }

    agent {label 'sumaform-cucumber' }
    stages {
     stage('deploy HEAD cucumber sle15 infrastructure') {
             steps {

                dir('prod') {
                    git url: sumaform_runner_url
                }

                dir('prod/sumaform') {
                    git url: sumaform_url
                }
      }
     }
      stage('run cucumber tests') {
        steps{
         script {
               try {
                 ansiColor('xterm') {
                  sh "mv prod/${maintf} prod/sumaform"
                       dir('prod/sumaform') {
                         ansiColor('xterm') {
                           sh 'terraform init'
                           sh 'terraform apply'
                             timeout(time: 6, unit:'HOURS') {
                           sh "ssh ${ssh_flags} -tt root@${ctl_node} run-testsuite"
                          }
                       }
                    }

                 }
               }
               finally {
                 sh "scp ${ssh_flags} root@${ctl_node}:/root/spacewalk/testsuite/output.html ${env.WORKSPACE}"
                 sh "scp ${ssh_flags} -rp root@$ctl_node:/root/spacewalk/testsuite/results_junit ${env.WORKSPACE}"
                 sh "scp ${ssh_flags} -rp root@$ctl_node:/root/spacewalk/testsuite/spacewalk-debug.tar.bz2 ${env.WORKSPACE}"
              }
            }
           }
        }
   }
 post {
        always {
           dir('prod/sumaform') {
                  ansiColor('xterm') {
                        sh 'terraform destroy -force'
                   }
                 }
            dir("${env.WORKSPACE}") {
              archiveArtifacts artifacts: 'output.html'
              junit 'results_junit/*.xml'
              archiveArtifacts artifacts: 'spacewalk-debug.tar.bz2'
              deleteDir()
            }
        }
    }

}
